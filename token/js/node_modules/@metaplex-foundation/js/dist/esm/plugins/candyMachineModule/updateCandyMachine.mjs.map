{"version":3,"file":"updateCandyMachine.mjs","sources":["../../../../src/plugins/candyMachineModule/updateCandyMachine.ts"],"sourcesContent":["import isEqual from 'lodash.isequal';\nimport type { ConfirmOptions, PublicKey } from '@solana/web3.js';\nimport {\n  createRemoveCollectionInstruction,\n  createSetCollectionInstruction,\n  createUpdateAuthorityInstruction,\n  createUpdateCandyMachineInstruction,\n} from '@metaplex-foundation/mpl-candy-machine';\nimport {\n  assertSameCurrencies,\n  Operation,\n  OperationHandler,\n  Signer,\n  SOL,\n  useOperation,\n} from '@/types';\nimport { Metaplex } from '@/Metaplex';\nimport { Option, TransactionBuilder } from '@/utils';\nimport { SendAndConfirmTransactionResponse } from '../rpcModule';\nimport {\n  CandyMachine,\n  CandyMachineConfigs,\n  toCandyMachineConfigs,\n  toCandyMachineInstructionData,\n} from './CandyMachine';\nimport { NoInstructionsToSendError } from '@/errors';\nimport {\n  findCollectionAuthorityRecordPda,\n  findMasterEditionV2Pda,\n  findMetadataPda,\n  isLazyNft,\n  isNft,\n  LazyNft,\n  Nft,\n  TokenMetadataProgram,\n} from '../nftModule';\nimport { findCandyMachineCollectionPda } from './pdas';\n\n// -----------------\n// Operation\n// -----------------\n\nconst Key = 'UpdateCandyMachineOperation' as const;\nexport const updateCandyMachineOperation =\n  useOperation<UpdateCandyMachineOperation>(Key);\nexport type UpdateCandyMachineOperation = Operation<\n  typeof Key,\n  UpdateCandyMachineInput,\n  UpdateCandyMachineOutput\n>;\n\nexport type UpdateCandyMachineInputWithoutConfigs = {\n  // Models and accounts.\n  candyMachine: CandyMachine;\n  authority?: Signer; // Defaults to mx.identity().\n  payer?: Signer; // Defaults to mx.identity().\n  newAuthority?: PublicKey;\n  newCollection?: Option<PublicKey | Nft | LazyNft>;\n\n  // Transaction Options.\n  confirmOptions?: ConfirmOptions;\n};\n\nexport type UpdateCandyMachineInput = UpdateCandyMachineInputWithoutConfigs &\n  Partial<CandyMachineConfigs>;\n\nexport type UpdateCandyMachineOutput = {\n  response: SendAndConfirmTransactionResponse;\n};\n\n// -----------------\n// Handler\n// -----------------\n\nexport const updateCandyMachineOperationHandler: OperationHandler<UpdateCandyMachineOperation> =\n  {\n    async handle(\n      operation: UpdateCandyMachineOperation,\n      metaplex: Metaplex\n    ): Promise<UpdateCandyMachineOutput> {\n      const builder = updateCandyMachineBuilder(metaplex, operation.input);\n\n      if (builder.isEmpty()) {\n        throw new NoInstructionsToSendError(Key);\n      }\n\n      return builder.sendAndConfirm(metaplex, operation.input.confirmOptions);\n    },\n  };\n\n// -----------------\n// Builder\n// -----------------\n\nexport type UpdateCandyMachineBuilderParams = Omit<\n  UpdateCandyMachineInput,\n  'confirmOptions'\n> & {\n  updateInstructionKey?: string;\n  updateAuthorityInstructionKey?: string;\n  setCollectionInstructionKey?: string;\n  removeCollectionInstructionKey?: string;\n};\n\nexport const updateCandyMachineBuilder = (\n  metaplex: Metaplex,\n  params: UpdateCandyMachineBuilderParams\n): TransactionBuilder => {\n  const {\n    candyMachine,\n    authority = metaplex.identity(),\n    payer = metaplex.identity(),\n    newAuthority,\n    newCollection: newCollectionParam,\n    ...updatableFields\n  } = params;\n  const currentConfigs = toCandyMachineConfigs(candyMachine);\n  const instructionDataWithoutChanges = toCandyMachineInstructionData(\n    candyMachine.address,\n    currentConfigs\n  );\n  const instructionData = toCandyMachineInstructionData(candyMachine.address, {\n    ...currentConfigs,\n    ...updatableFields,\n  });\n  const { data, wallet, tokenMint } = instructionData;\n  const shouldSendUpdateInstruction = !isEqual(\n    instructionData,\n    instructionDataWithoutChanges\n  );\n  const shouldSendUpdateAuthorityInstruction =\n    !!newAuthority && !newAuthority.equals(authority.publicKey);\n\n  const newCollection =\n    newCollectionParam &&\n    (isNft(newCollectionParam) || isLazyNft(newCollectionParam))\n      ? newCollectionParam.mintAddress\n      : newCollectionParam;\n  const sameCollection =\n    newCollection &&\n    candyMachine.collectionMintAddress &&\n    candyMachine.collectionMintAddress.equals(newCollection);\n  const shouldSendSetCollectionInstruction = !!newCollection && !sameCollection;\n  const shouldSendRemoveCollectionInstruction =\n    !shouldSendSetCollectionInstruction &&\n    newCollection === null &&\n    candyMachine.collectionMintAddress !== null;\n\n  const updateInstruction = createUpdateCandyMachineInstruction(\n    {\n      candyMachine: candyMachine.address,\n      authority: authority.publicKey,\n      wallet,\n    },\n    { data }\n  );\n\n  if (tokenMint) {\n    updateInstruction.keys.push({\n      pubkey: tokenMint,\n      isWritable: false,\n      isSigner: false,\n    });\n  } else if (params.price) {\n    assertSameCurrencies(params.price, SOL);\n  }\n\n  return (\n    TransactionBuilder.make()\n\n      // Update data.\n      .when(shouldSendUpdateInstruction, (builder) =>\n        builder.add({\n          instruction: updateInstruction,\n          signers: [authority],\n          key: params.updateInstructionKey ?? 'update',\n        })\n      )\n\n      // Update authority.\n      .when(shouldSendUpdateAuthorityInstruction, (builder) =>\n        builder.add({\n          instruction: createUpdateAuthorityInstruction(\n            {\n              candyMachine: candyMachine.address,\n              authority: authority.publicKey,\n              wallet: candyMachine.walletAddress,\n            },\n            { newAuthority: newAuthority as PublicKey }\n          ),\n          signers: [authority],\n          key: params.updateAuthorityInstructionKey ?? 'updateAuthority',\n        })\n      )\n\n      // Set or update collection.\n      .when(shouldSendSetCollectionInstruction, (builder) => {\n        const collectionMint = newCollection as PublicKey;\n        const metadata = findMetadataPda(collectionMint);\n        const edition = findMasterEditionV2Pda(collectionMint);\n        const collectionPda = findCandyMachineCollectionPda(\n          candyMachine.address\n        );\n        const collectionAuthorityRecord = findCollectionAuthorityRecordPda(\n          collectionMint,\n          collectionPda\n        );\n\n        return builder.add({\n          instruction: createSetCollectionInstruction({\n            candyMachine: candyMachine.address,\n            authority: authority.publicKey,\n            collectionPda,\n            payer: payer.publicKey,\n            metadata,\n            mint: collectionMint,\n            edition,\n            collectionAuthorityRecord,\n            tokenMetadataProgram: TokenMetadataProgram.publicKey,\n          }),\n          signers: [payer, authority],\n          key: params.setCollectionInstructionKey ?? 'setCollection',\n        });\n      })\n\n      // Remove collection.\n      .when(shouldSendRemoveCollectionInstruction, (builder) => {\n        const collectionMint = candyMachine.collectionMintAddress as PublicKey;\n        const metadata = findMetadataPda(collectionMint);\n        const collectionPda = findCandyMachineCollectionPda(\n          candyMachine.address\n        );\n        const collectionAuthorityRecord = findCollectionAuthorityRecordPda(\n          collectionMint,\n          collectionPda\n        );\n\n        return builder.add({\n          instruction: createRemoveCollectionInstruction({\n            candyMachine: candyMachine.address,\n            authority: authority.publicKey,\n            collectionPda,\n            metadata,\n            mint: collectionMint,\n            collectionAuthorityRecord,\n            tokenMetadataProgram: TokenMetadataProgram.publicKey,\n          }),\n          signers: [authority],\n          key: params.removeCollectionInstructionKey ?? 'removeCollection',\n        });\n      })\n  );\n};\n"],"names":["Key","updateCandyMachineOperation","useOperation","updateCandyMachineOperationHandler","handle","operation","metaplex","builder","updateCandyMachineBuilder","input","isEmpty","NoInstructionsToSendError","sendAndConfirm","confirmOptions","params","candyMachine","authority","identity","payer","newAuthority","newCollection","newCollectionParam","updatableFields","currentConfigs","toCandyMachineConfigs","instructionDataWithoutChanges","toCandyMachineInstructionData","address","instructionData","data","wallet","tokenMint","shouldSendUpdateInstruction","isEqual","shouldSendUpdateAuthorityInstruction","equals","publicKey","isNft","isLazyNft","mintAddress","sameCollection","collectionMintAddress","shouldSendSetCollectionInstruction","shouldSendRemoveCollectionInstruction","updateInstruction","createUpdateCandyMachineInstruction","keys","push","pubkey","isWritable","isSigner","price","assertSameCurrencies","SOL","TransactionBuilder","make","when","add","instruction","signers","key","updateInstructionKey","createUpdateAuthorityInstruction","walletAddress","updateAuthorityInstructionKey","collectionMint","metadata","findMetadataPda","edition","findMasterEditionV2Pda","collectionPda","findCandyMachineCollectionPda","collectionAuthorityRecord","findCollectionAuthorityRecordPda","createSetCollectionInstruction","mint","tokenMetadataProgram","TokenMetadataProgram","setCollectionInstructionKey","createRemoveCollectionInstruction","removeCollectionInstructionKey"],"mappings":"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"}