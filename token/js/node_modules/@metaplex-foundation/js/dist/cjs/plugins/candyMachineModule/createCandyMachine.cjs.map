{"version":3,"file":"createCandyMachine.cjs","sources":["../../../../src/plugins/candyMachineModule/createCandyMachine.ts"],"sourcesContent":["import { ConfirmOptions, Keypair, PublicKey } from '@solana/web3.js';\nimport {\n  createInitializeCandyMachineInstruction,\n  createSetCollectionInstruction,\n  Creator,\n} from '@metaplex-foundation/mpl-candy-machine';\nimport { Metaplex } from '@/Metaplex';\nimport {\n  Operation,\n  useOperation,\n  Signer,\n  OperationHandler,\n  assertSameCurrencies,\n  SOL,\n  toBigNumber,\n  toUniformCreators,\n  toPublicKey,\n  isSigner,\n} from '@/types';\nimport {\n  DisposableScope,\n  Option,\n  RequiredKeys,\n  TransactionBuilder,\n} from '@/utils';\nimport { CandyMachineProgram } from './program';\nimport { SendAndConfirmTransactionResponse } from '../rpcModule';\nimport { getCandyMachineAccountSizeFromData } from './helpers';\nimport {\n  CandyMachineConfigs,\n  toCandyMachineInstructionData,\n} from './CandyMachine';\nimport {\n  findCollectionAuthorityRecordPda,\n  findMasterEditionV2Pda,\n  findMetadataPda,\n  isLazyNft,\n  isNft,\n  LazyNft,\n  Nft,\n  TokenMetadataProgram,\n} from '../nftModule';\nimport { findCandyMachineCollectionPda } from './pdas';\nimport { CandyMachineAuthorityRequiredAsASignerError } from './errors';\n\n// -----------------\n// Operation\n// -----------------\n\nconst Key = 'CreateCandyMachineOperation' as const;\nexport const createCandyMachineOperation =\n  useOperation<CreateCandyMachineOperation>(Key);\nexport type CreateCandyMachineOperation = Operation<\n  typeof Key,\n  CreateCandyMachineInput,\n  CreateCandyMachineOutput\n>;\n\nexport type CreateCandyMachineInputWithoutConfigs = {\n  // Accounts and Models.\n  candyMachine?: Signer; // Defaults to Keypair.generate().\n  payer?: Signer; // Defaults to mx.identity().\n  authority?: Signer | PublicKey; // Defaults to mx.identity().\n  collection?: Option<PublicKey | Nft | LazyNft>; // Defaults to no collection.\n\n  // Transaction Options.\n  confirmOptions?: ConfirmOptions;\n};\n\nexport type CreateCandyMachineInput = CreateCandyMachineInputWithoutConfigs &\n  RequiredKeys<\n    Partial<CandyMachineConfigs>,\n    'price' | 'sellerFeeBasisPoints' | 'itemsAvailable'\n  >;\n\nexport type CreateCandyMachineOutput = {\n  response: SendAndConfirmTransactionResponse;\n  candyMachineSigner: Signer;\n  payer: Signer;\n  wallet: PublicKey;\n  authority: PublicKey;\n  creators: Creator[];\n};\n\n// -----------------\n// Handler\n// -----------------\n\nexport const createCandyMachineOperationHandler: OperationHandler<CreateCandyMachineOperation> =\n  {\n    async handle(\n      operation: CreateCandyMachineOperation,\n      metaplex: Metaplex,\n      scope: DisposableScope\n    ): Promise<CreateCandyMachineOutput> {\n      const builder = await createCandyMachineBuilder(\n        metaplex,\n        operation.input\n      );\n      scope.throwIfCanceled();\n      return builder.sendAndConfirm(metaplex, operation.input.confirmOptions);\n    },\n  };\n\n// -----------------\n// Builder\n// -----------------\n\nexport type CreateCandyMachineBuilderParams = Omit<\n  CreateCandyMachineInput,\n  'confirmOptions'\n> & {\n  createAccountInstructionKey?: string;\n  initializeCandyMachineInstructionKey?: string;\n  setCollectionInstructionKey?: string;\n};\n\nexport type CreateCandyMachineBuilderContext = Omit<\n  CreateCandyMachineOutput,\n  'response'\n>;\n\nexport const createCandyMachineBuilder = async (\n  metaplex: Metaplex,\n  params: CreateCandyMachineBuilderParams\n): Promise<TransactionBuilder<CreateCandyMachineBuilderContext>> => {\n  const candyMachine = params.candyMachine ?? Keypair.generate();\n  const payer: Signer = params.payer ?? metaplex.identity();\n  const authority = params.authority ?? metaplex.identity();\n  const collection: PublicKey | null =\n    params.collection &&\n    (isNft(params.collection) || isLazyNft(params.collection))\n      ? params.collection.mintAddress\n      : params.collection ?? null;\n\n  const { data, wallet, tokenMint } = toCandyMachineInstructionData(\n    candyMachine.publicKey,\n    {\n      ...params,\n      wallet: params.wallet ?? metaplex.identity().publicKey,\n      tokenMint: params.tokenMint ?? null,\n      symbol: params.symbol ?? '',\n      maxEditionSupply: params.maxEditionSupply ?? toBigNumber(0),\n      isMutable: params.isMutable ?? true,\n      retainAuthority: params.retainAuthority ?? true,\n      goLiveDate: params.goLiveDate ?? null,\n      endSettings: params.endSettings ?? null,\n      creators:\n        params.creators ?? toUniformCreators(metaplex.identity().publicKey),\n      hiddenSettings: params.hiddenSettings ?? null,\n      whitelistMintSettings: params.whitelistMintSettings ?? null,\n      gatekeeper: params.gatekeeper ?? null,\n    }\n  );\n\n  const initializeInstruction = createInitializeCandyMachineInstruction(\n    {\n      candyMachine: candyMachine.publicKey,\n      wallet,\n      authority: toPublicKey(authority),\n      payer: payer.publicKey,\n    },\n    { data }\n  );\n\n  if (tokenMint) {\n    initializeInstruction.keys.push({\n      pubkey: tokenMint,\n      isWritable: false,\n      isSigner: false,\n    });\n  } else {\n    assertSameCurrencies(params.price, SOL);\n  }\n\n  return (\n    TransactionBuilder.make<CreateCandyMachineBuilderContext>()\n      .setFeePayer(payer)\n      .setContext({\n        candyMachineSigner: candyMachine,\n        payer,\n        wallet,\n        authority: toPublicKey(authority),\n        creators: data.creators,\n      })\n\n      // Create an empty account for the candy machine.\n      .add(\n        await metaplex\n          .system()\n          .builders()\n          .createAccount({\n            payer,\n            newAccount: candyMachine,\n            space: getCandyMachineAccountSizeFromData(data),\n            program: CandyMachineProgram.publicKey,\n            instructionKey:\n              params.createAccountInstructionKey ?? 'createAccount',\n          })\n      )\n\n      // Initialize the candy machine account.\n      .add({\n        instruction: initializeInstruction,\n        signers: [candyMachine, payer],\n        key:\n          params.initializeCandyMachineInstructionKey ??\n          'initializeCandyMachine',\n      })\n\n      // Set the collection.\n      .when(!!collection, (builder) => {\n        if (!isSigner(authority)) {\n          throw new CandyMachineAuthorityRequiredAsASignerError();\n        }\n\n        const collectionMint = collection as PublicKey;\n        const metadata = findMetadataPda(collectionMint);\n        const edition = findMasterEditionV2Pda(collectionMint);\n        const collectionPda = findCandyMachineCollectionPda(\n          candyMachine.publicKey\n        );\n        const collectionAuthorityRecord = findCollectionAuthorityRecordPda(\n          collectionMint,\n          collectionPda\n        );\n\n        return builder.add({\n          instruction: createSetCollectionInstruction({\n            candyMachine: candyMachine.publicKey,\n            authority: toPublicKey(authority),\n            collectionPda,\n            payer: payer.publicKey,\n            metadata,\n            mint: collectionMint,\n            edition,\n            collectionAuthorityRecord,\n            tokenMetadataProgram: TokenMetadataProgram.publicKey,\n          }),\n          signers: [authority],\n          key: params.setCollectionInstructionKey ?? 'setCollection',\n        });\n      })\n  );\n};\n"],"names":["Key","createCandyMachineOperation","useOperation","createCandyMachineOperationHandler","handle","operation","metaplex","scope","builder","createCandyMachineBuilder","input","throwIfCanceled","sendAndConfirm","confirmOptions","params","candyMachine","Keypair","generate","payer","identity","authority","collection","isNft","isLazyNft","mintAddress","data","wallet","tokenMint","toCandyMachineInstructionData","publicKey","symbol","maxEditionSupply","toBigNumber","isMutable","retainAuthority","goLiveDate","endSettings","creators","toUniformCreators","hiddenSettings","whitelistMintSettings","gatekeeper","initializeInstruction","createInitializeCandyMachineInstruction","toPublicKey","keys","push","pubkey","isWritable","isSigner","assertSameCurrencies","price","SOL","TransactionBuilder","make","setFeePayer","setContext","candyMachineSigner","add","system","builders","createAccount","newAccount","space","getCandyMachineAccountSizeFromData","program","CandyMachineProgram","instructionKey","createAccountInstructionKey","instruction","signers","key","initializeCandyMachineInstructionKey","when","CandyMachineAuthorityRequiredAsASignerError","collectionMint","metadata","findMetadataPda","edition","findMasterEditionV2Pda","collectionPda","findCandyMachineCollectionPda","collectionAuthorityRecord","findCollectionAuthorityRecordPda","createSetCollectionInstruction","mint","tokenMetadataProgram","TokenMetadataProgram","setCollectionInstructionKey"],"mappings":"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"}