{"version":3,"file":"findTokenWithMetadataByAddress.cjs","sources":["../../../../src/plugins/nftModule/findTokenWithMetadataByAddress.ts"],"sourcesContent":["import type { Commitment, PublicKey } from '@solana/web3.js';\nimport { Metaplex } from '@/Metaplex';\nimport { Operation, useOperation, OperationHandler } from '@/types';\nimport {\n  toTokenWithMetadata,\n  TokenWithMetadata,\n  Metadata,\n  LazyMetadata,\n  toLazyMetadata,\n} from './Metadata';\nimport {\n  toMint,\n  toTokenWithMint,\n  TokenWithMint,\n  toMintAccount,\n  toTokenAccount,\n} from '../tokenModule';\nimport { parseMetadataAccount } from './accounts';\nimport { findMetadataPda } from './pdas';\nimport { DisposableScope } from '@/utils';\n\n// -----------------\n// Operation\n// -----------------\n\nconst Key = 'FindTokenWithMetadataByAddressOperation' as const;\nexport const findTokenWithMetadataByAddressOperation =\n  useOperation<FindTokenWithMetadataByAddressOperation>(Key);\nexport type FindTokenWithMetadataByAddressOperation = Operation<\n  typeof Key,\n  FindTokenWithMetadataByAddressInput,\n  TokenWithMetadata | TokenWithMint\n>;\n\nexport type FindTokenWithMetadataByAddressInput = {\n  address: PublicKey;\n  commitment?: Commitment;\n  loadJsonMetadata?: boolean; // Default: true\n};\n\n// -----------------\n// Handler\n// -----------------\n\nexport const findTokenWithMetadataByAddressOperationHandler: OperationHandler<FindTokenWithMetadataByAddressOperation> =\n  {\n    handle: async (\n      operation: FindTokenWithMetadataByAddressOperation,\n      metaplex: Metaplex,\n      scope: DisposableScope\n    ): Promise<TokenWithMetadata | TokenWithMint> => {\n      const { address, commitment, loadJsonMetadata = true } = operation.input;\n\n      const tokenAccount = toTokenAccount(\n        await metaplex.rpc().getAccount(address, commitment)\n      );\n\n      const mintAddress = tokenAccount.data.mint;\n      const metadataAddress = findMetadataPda(mintAddress);\n      const accounts = await metaplex\n        .rpc()\n        .getMultipleAccounts([mintAddress, metadataAddress], commitment);\n      scope.throwIfCanceled();\n\n      const mintAccount = toMintAccount(accounts[0]);\n      const metadataAccount = parseMetadataAccount(accounts[1]);\n      const mintModel = toMint(mintAccount);\n\n      if (!metadataAccount.exists) {\n        return toTokenWithMint(tokenAccount, mintModel);\n      }\n\n      let metadataModel: Metadata | LazyMetadata =\n        toLazyMetadata(metadataAccount);\n\n      if (loadJsonMetadata) {\n        metadataModel = await metaplex\n          .nfts()\n          .loadMetadata(metadataModel)\n          .run(scope);\n      }\n\n      return toTokenWithMetadata(tokenAccount, mintModel, metadataModel);\n    },\n  };\n"],"names":["Key","findTokenWithMetadataByAddressOperation","useOperation","findTokenWithMetadataByAddressOperationHandler","handle","operation","metaplex","scope","address","commitment","loadJsonMetadata","input","tokenAccount","toTokenAccount","rpc","getAccount","mintAddress","data","mint","metadataAddress","findMetadataPda","accounts","getMultipleAccounts","throwIfCanceled","mintAccount","toMintAccount","metadataAccount","parseMetadataAccount","mintModel","toMint","exists","toTokenWithMint","metadataModel","toLazyMetadata","nfts","loadMetadata","run","toTokenWithMetadata"],"mappings":";;;;;;;;;;;;AAqBA;AACA;AACA;AAEA,MAAMA,GAAG,GAAG,yCAAZ,CAAA;MACaC,uCAAuC,GAClDC,sBAAY,CAA0CF,GAA1C,EADP;AAcP;AACA;AACA;AAEO,MAAMG,8CAAyG,GACpH;AACEC,EAAAA,MAAM,EAAE,OACNC,SADM,EAENC,QAFM,EAGNC,KAHM,KAIyC;IAC/C,MAAM;MAAEC,OAAF;MAAWC,UAAX;AAAuBC,MAAAA,gBAAgB,GAAG,IAAA;KAASL,GAAAA,SAAS,CAACM,KAAnE,CAAA;AAEA,IAAA,MAAMC,YAAY,GAAGC,uBAAc,CACjC,MAAMP,QAAQ,CAACQ,GAAT,EAAA,CAAeC,UAAf,CAA0BP,OAA1B,EAAmCC,UAAnC,CAD2B,CAAnC,CAAA;AAIA,IAAA,MAAMO,WAAW,GAAGJ,YAAY,CAACK,IAAb,CAAkBC,IAAtC,CAAA;AACA,IAAA,MAAMC,eAAe,GAAGC,oBAAe,CAACJ,WAAD,CAAvC,CAAA;AACA,IAAA,MAAMK,UAAQ,GAAG,MAAMf,QAAQ,CAC5BQ,GADoB,EAEpBQ,CAAAA,mBAFoB,CAEA,CAACN,WAAD,EAAcG,eAAd,CAFA,EAEgCV,UAFhC,CAAvB,CAAA;AAGAF,IAAAA,KAAK,CAACgB,eAAN,EAAA,CAAA;IAEA,MAAMC,WAAW,GAAGC,sBAAa,CAACJ,UAAQ,CAAC,CAAD,CAAT,CAAjC,CAAA;IACA,MAAMK,eAAe,GAAGC,+BAAoB,CAACN,UAAQ,CAAC,CAAD,CAAT,CAA5C,CAAA;AACA,IAAA,MAAMO,SAAS,GAAGC,WAAM,CAACL,WAAD,CAAxB,CAAA;;AAEA,IAAA,IAAI,CAACE,eAAe,CAACI,MAArB,EAA6B;AAC3B,MAAA,OAAOC,qBAAe,CAACnB,YAAD,EAAegB,SAAf,CAAtB,CAAA;AACD,KAAA;;AAED,IAAA,IAAII,aAAsC,GACxCC,uBAAc,CAACP,eAAD,CADhB,CAAA;;AAGA,IAAA,IAAIhB,gBAAJ,EAAsB;AACpBsB,MAAAA,aAAa,GAAG,MAAM1B,QAAQ,CAC3B4B,IADmB,EAAA,CAEnBC,YAFmB,CAENH,aAFM,CAAA,CAGnBI,GAHmB,CAGf7B,KAHe,CAAtB,CAAA;AAID,KAAA;;AAED,IAAA,OAAO8B,4BAAmB,CAACzB,YAAD,EAAegB,SAAf,EAA0BI,aAA1B,CAA1B,CAAA;AACD,GAAA;AAtCH;;;;;"}